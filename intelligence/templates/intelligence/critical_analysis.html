{% extends 'intelligence/base.html' %}
{% load static %}

{% block title %}تقدير موقف استراتيجي - {{ report.title }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header Warning -->
    <div class="bg-red-900/20 border-y-2 border-red-600 text-center py-2 mb-8 animate-pulse">
        <h1 class="text-red-500 font-mono text-xl tracking-widest font-bold">
            <i class="fas fa-siren-on mr-2"></i> تقرير موقف استراتيجي عاجل (TOP SECRET)
        </h1>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Main Analysis Column -->
        <div class="lg:col-span-2">
            <div class="bg-gray-800 rounded-lg shadow-2xl border border-gray-700 overflow-hidden">
                <div class="bg-gray-900 px-6 py-4 border-b border-gray-700 flex justify-between items-center">
                    <h2 class="text-xl font-bold text-white">
                        <i class="fas fa-brain text-purple-400 ml-2"></i> تحليل الذكاء الاصطناعي (Smart Analyst)
                    </h2>
                    <span class="text-xs font-mono text-gray-500">{{ report.created_at|date:"Y-m-d H:i:s" }}</span>
                </div>
                
                <div class="p-8 text-gray-200 leading-relaxed space-y-4 font-serif text-lg">
                    <!-- Display Analysis with simple formatting support -->
                    <div class="prose prose-invert max-w-none prose-lg">
                        {{ analysis|linebreaks }}
                    </div>
                </div>

                <div class="bg-gray-900/50 px-6 py-3 border-t border-gray-700 text-right">
                    <button onclick="window.print()" class="text-gray-400 hover:text-white text-sm">
                        <i class="fas fa-print ml-1"></i> طباعة التقدير
                    </button>
                </div>
            </div>
        </div>

        <!-- Sidebar: Source Intel -->
        <div class="lg:col-span-1 space-y-6">
            <!-- Source Report Card -->
            <div class="bg-gray-800 rounded-lg border border-gray-600 p-4">
                <h3 class="text-gray-400 text-sm font-bold uppercase mb-3 border-b border-gray-700 pb-2">التقرير الأصلي</h3>
                <h4 class="font-bold text-white mb-2">{{ report.title }}</h4>
                <div class="text-sm text-gray-400 mb-4 h-32 overflow-y-auto custom-scrollbar">
                    {{ report.content }}
                </div>
                <a href="{% url 'report_detail' report.id %}" class="block w-full text-center bg-gray-700 hover:bg-gray-600 text-white py-2 rounded text-sm transition">
                    عرض التقرير الكامل
                </a>
            </div>

            <!-- Metadata -->
            <div class="bg-gray-800 rounded-lg border border-gray-600 p-4">
                <h3 class="text-gray-400 text-sm font-bold uppercase mb-3 border-b border-gray-700 pb-2">بيانات الرصد</h3>
                <ul class="space-y-2 text-sm">
                    <li class="flex justify-between">
                        <span class="text-gray-500">المصدر:</span>
                        <span class="text-blue-400">{{ report.source.name }}</span>
                    </li>
                    <li class="flex justify-between">
                        <span class="text-gray-500">مستوى الخطورة:</span>
                        <span class="text-red-500 font-bold">{{ report.get_severity_display }}</span>
                    </li>
                    <li class="flex justify-between">
                        <span class="text-gray-500">التصنيف:</span>
                        <span class="text-yellow-500">{{ report.get_topic_display }}</span>
                    </li>
                </ul>
            </div>
        </div>

    </div>
</div>

<style>
    /* Simple styling for the markdown-like output if needed */
    .prose strong { color: #f87171; font-weight: 800; }
    .prose h3 { color: #60a5fa; font-size: 1.25rem; font-weight: 700; margin-top: 1.5em; margin-bottom: 0.5em; }
    .prose ul { list-style-type: disc; padding-right: 1.5em; margin-bottom: 1em; }
    .prose li { margin-bottom: 0.25em; }

    /* Print Styling */
    .print-header { display: none; }
    @media print {
        body * {
            visibility: hidden;
        }
        .lg\:col-span-2, .lg\:col-span-2 * {
            visibility: visible;
        }
        .lg\:col-span-2 {
            position: absolute;
            left: 0;
            top: 100px;
            width: 100%;
        }
        .print-header {
            display: block;
            visibility: visible;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            text-align: center;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
        }
        .bg-gray-800, .bg-gray-900 {
            background-color: white !important;
            color: black !important;
            border: none !important;
            box-shadow: none !important;
        }
        .text-white, .text-gray-200 { color: black !important; }
        .text-red-500, .text-purple-400, .text-blue-400 { color: black !important; font-weight: bold; }
        button { display: none !important; }
    }
</style>

<div class="print-header">
    <h1 style="font-size: 24px; font-weight: bold;">منصة الاستقصاء الذكي</h1>
    <p style="font-size: 14px;">لتحليل المعلومات من المصادر المفتوحة</p>
</div>

<script>
    // Optional: Simple client-side formatting for **text**
    document.addEventListener('DOMContentLoaded', function() {
        const contentDiv = document.querySelector('.prose');
        if(contentDiv) {
            let html = contentDiv.innerHTML;
            // Bold
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong class="text-red-400">$1</strong>');
            // Headers (###)
            html = html.replace(/###\s(.*?)(<br>|$)/g, '<h3 class="text-xl font-bold text-blue-400 mt-4 mb-2">$1</h3>');
            // Lists (-)
            // html = html.replace(/- (.*?)(<br>|$)/g, '<li class="ml-4 list-disc">$1</li>');
            contentDiv.innerHTML = html;
        }
    });
</script>
{% endblock %}
