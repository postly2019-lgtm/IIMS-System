<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ù…Ù†ÙŠ Ù„Ø¬Ù…Ø¹ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</title>
    
    <!-- Sovereign Style Handling -->
    <!-- Fallback to CDN for Production Stability until Local Build Pipeline is verified -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#22d3ee',
                        accent: '#10b981',
                    }
                }
            }
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0b1220;
            --panel: rgba(19, 28, 45, 0.75);
            --border: #1f2b44;
            --text: #d6e3ff;
            --muted: #8aa2c6;
            --primary: #22d3ee;
            --accent: #10b981;
        }
        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .animate-shake {
            animation: shake 0.5s;
            animation-iteration-count: 3;
        }
        .glass-panel {
            background: var(--panel);
            backdrop-filter: blur(14px);
            border: 1px solid var(--border);
            border-radius: 16px;
        }
        .status-badge-U { background-color: #22c55e; color: #031520; }
        .status-badge-R { background-color: #eab308; color: #031520; }
        .status-badge-C { background-color: #f97316; color: #031520; }
        .status-badge-S { background-color: #ef4444; color: #ffffff; }
        .status-badge-TS { background-color: #0b0b0b; color: #ef4444; border: 1px solid #ef4444; }
        .brand-bar { height: 2px; background: linear-gradient(90deg, transparent, var(--primary), var(--accent), transparent); }
        
        /* Sidebar Styling */
        #main-sidebar {
            position: fixed;
            right: 0;
            top: 0;
            height: 100vh;
            width: 280px; /* Slightly wider */
            z-index: 50;
            border-left: 1px solid var(--border);
            border-radius: 0;
        }
        
        /* Content Area */
        #main-content {
            margin-right: 280px; /* Match sidebar width */
            padding: 2rem;
            min-height: 100vh;
        }

        {% if not request.user.is_authenticated %}
        #main-sidebar { display: none !important; }
        #main-content { margin-right: 0 !important; }
        {% endif %}
    </style>
</head>
<body>

    <!-- SIDEBAR NAVIGATION ONLY - NO TOP MENU -->
    <aside id="main-sidebar" class="glass-panel flex flex-col p-6">
        <!-- Brand / Title -->
        <div class="mb-10 text-center">
            <h1 class="text-2xl font-bold mb-1" style="color: var(--primary)">Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªØ®Ø¨Ø§Ø±Ø§Øª</h1>
            <p class="text-[10px] tracking-widest uppercase opacity-70">Integrated System</p>
            <div class="brand-bar mt-4 mx-auto w-1/2"></div>
        </div>

        <!-- Navigation Links -->
        <nav class="flex-1 flex flex-col gap-3 overflow-y-auto">
            <a href="{% url 'dashboard' %}" class="flex items-center gap-4 px-4 py-3 rounded-lg transition hover:bg-white/5 group border border-transparent hover:border-white/10" style="color: var(--text);">
                <span class="text-xl opacity-70 group-hover:opacity-100 group-hover:text-cyan-400">ğŸ </span>
                <span class="font-bold text-sm">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
            </a>

            <a href="{% url 'search' %}" class="flex items-center gap-4 px-4 py-3 rounded-lg transition hover:bg-white/5 group border border-transparent hover:border-white/10" style="color: var(--text);">
                <span class="text-xl opacity-70 group-hover:opacity-100 group-hover:text-cyan-400">ğŸ”</span>
                <span class="font-bold text-sm">Ø¨Ø­Ø« Ù…ØªÙ‚Ø¯Ù…</span>
            </a>

            <a href="{% url 'favorites_list' %}" class="flex items-center gap-4 px-4 py-3 rounded-lg transition hover:bg-white/5 group border border-transparent hover:border-white/10" style="color: var(--text);">
                <span class="text-xl opacity-70 group-hover:opacity-100 group-hover:text-yellow-400">â­</span>
                <span class="font-bold text-sm">Ø§Ù„Ù…ÙØ¶Ù„Ø©</span>
            </a>

            <a href="{% url 'agent_chat_root' %}" class="flex items-center gap-4 px-4 py-3 rounded-lg transition hover:bg-white/5 group border border-transparent hover:border-white/10 relative overflow-hidden">
                            <div class="absolute inset-0 bg-gradient-to-r from-gray-900/20 to-transparent opacity-0 group-hover:opacity-100 transition duration-500"></div>
                            <span class="text-xl opacity-70 group-hover:opacity-100 group-hover:text-gray-300">ğŸ¤–</span>
                            <span class="font-bold text-gray-400 group-hover:text-gray-300">Ø§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ø°ÙƒÙŠ</span>
                        </a>
            
            <a href="{% url 'graph_view' %}" class="flex items-center gap-4 px-4 py-3 rounded-lg transition hover:bg-white/5 group border border-transparent hover:border-white/10">
                <span class="text-xl opacity-70 group-hover:opacity-100 group-hover:text-cyan-400">ğŸ•¸ï¸</span>
                <span class="font-bold text-sm">Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©</span>
            </a>

            {% if request.user.is_staff %}
            <div class="my-4 border-t border-white/5"></div>
            
            <a href="{% url 'source_manager' %}" class="flex items-center gap-4 px-4 py-3 rounded-lg transition hover:bg-white/5 group border border-transparent hover:border-white/10">
                <span class="text-xl opacity-70 group-hover:opacity-100 group-hover:text-amber-400">ğŸ“¡</span>
                <span class="font-bold text-sm">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØµØ§Ø¯Ø±</span>
            </a>

            <a href="{% url 'user_list' %}" class="flex items-center gap-4 px-4 py-3 rounded-lg transition hover:bg-white/5 group border border-transparent hover:border-white/10">
                <span class="text-xl opacity-70 group-hover:opacity-100 group-hover:text-emerald-400">ğŸ‘¥</span>
                <span class="font-bold text-sm">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
            </a>
            
            <a href="{% url 'audit_log' %}" class="flex items-center gap-4 px-4 py-3 rounded-lg transition hover:bg-white/5 group border border-transparent hover:border-white/10">
                <span class="text-xl opacity-70 group-hover:opacity-100 group-hover:text-red-400">ğŸ›¡ï¸</span>
                <span class="font-bold text-sm">Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</span>
            </a>
            {% endif %}
        </nav>

        <!-- System Status Summary -->
        <div class="mt-6 pt-6 border-t border-white/10">
            <h4 class="text-[10px] mb-4 font-bold uppercase tracking-wider opacity-50">System Status</h4>
            <div class="space-y-3 text-xs">
                <div class="flex justify-between items-center">
                    <span class="opacity-70">Reports (24h)</span>
                    <span class="font-mono font-bold bg-white/5 px-2 py-0.5 rounded">{{ recent_reports_count|default:0 }}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="opacity-70">Ingestion</span>
                    <div class="flex items-center gap-1.5">
                        <span class="w-2 h-2 rounded-full {% if ingestion_online %}bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]{% else %}bg-red-500{% endif %}"></span>
                        <span class="font-bold {% if ingestion_online %}text-emerald-500{% else %}text-red-500{% endif %}">{% if ingestion_online %}ON{% else %}OFF{% endif %}</span>
                    </div>
                </div>
                <div class="flex justify-between items-center">
                    <span class="opacity-70">Analysis</span>
                    <div class="flex items-center gap-1.5">
                        <span class="w-2 h-2 rounded-full {% if analysis_online %}bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]{% else %}bg-red-500{% endif %}"></span>
                        <span class="font-bold {% if analysis_online %}text-emerald-500{% else %}text-red-500{% endif %}">{% if analysis_online %}ON{% else %}OFF{% endif %}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Profile -->
        <div class="mt-6 pt-6 border-t border-white/10">
            {% if request.user.is_authenticated %}
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-full bg-gradient-to-br from-cyan-900 to-blue-900 border border-cyan-500/30 flex items-center justify-center text-xs font-bold text-cyan-200">
                        {{ request.user.username|slice:":2"|upper }}
                    </div>
                    <div class="flex flex-col">
                        <span class="text-xs font-bold leading-tight">{{ request.user.first_name|default:request.user.username }}</span>
                        <span class="text-[10px] opacity-50">Online</span>
                    </div>
                </div>
                <form action="{% url 'logout' %}" method="post">
                    {% csrf_token %}
                    <button type="submit" class="text-red-400 hover:text-red-300 transition p-2 rounded hover:bg-red-500/10" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                    </button>
                </form>
            </div>
            {% endif %}
        </div>
    </aside>

    <!-- Main Content Area -->
    <main id="main-content" class="relative">
        
        <!-- SECURITY TICKER BAR (REMOVED) -->
        <!-- User requested removal due to speed and annoyance -->

        <!-- Top Header -->
        <div class="flex justify-between items-center mb-8 sticky top-0 z-40 p-4 rounded-xl backdrop-blur-md bg-[#0b1220]/80 border-b border-white/5">
            
            <!-- Dynamic Page Title with Threat Level -->
            <div class="flex items-center gap-4">
                <h2 class="text-xl font-bold text-slate-400 flex items-center gap-2">
                    {% block header_title %}{% endblock %}
                </h2>
                
                <!-- THREAT LEVEL INDICATOR (DEFCON STYLE) -->
                <div id="threat-level-bar" class="hidden flex items-center gap-1 bg-black/40 px-3 py-1 rounded border border-white/10">
                    <span class="text-[10px] text-slate-500 font-mono uppercase">Threat Level:</span>
                    <div class="flex gap-1">
                        <div id="defcon-1" class="w-3 h-3 rounded-full bg-slate-800"></div>
                        <div id="defcon-2" class="w-3 h-3 rounded-full bg-slate-800"></div>
                        <div id="defcon-3" class="w-3 h-3 rounded-full bg-slate-800"></div>
                    </div>
                    <span id="threat-text" class="text-xs font-bold text-slate-400 ml-2">LOW</span>
                </div>
            </div>

            <div class="flex items-center gap-6">
                <!-- Search Trigger -->
                <button class="text-slate-400 hover:text-white transition">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </button>
                
                <!-- Notification Bell -->
                <div class="relative cursor-pointer group" id="notif-btn" onclick="toggleNotifPanel()">
                    <span class="text-2xl opacity-70 group-hover:opacity-100 transition">ğŸ””</span>
                    <span id="notif-badge" class="absolute -top-1 -right-1 w-4 h-4 bg-red-600 rounded-full text-[10px] flex items-center justify-center hidden shadow-lg shadow-red-500/50">0</span>
                </div>

                <!-- User Avatar (Mini) -->
                {% if request.user.is_authenticated %}
                <div class="w-8 h-8 rounded-full bg-cyan-900/50 border border-cyan-500/30 flex items-center justify-center text-[10px] font-bold text-cyan-200">
                    {{ request.user.username|slice:":2"|upper }}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Flash Messages -->
        {% if messages %}
        <div class="mb-8 space-y-2 max-w-4xl mx-auto">
            {% for message in messages %}
            <div class="glass-panel p-4 rounded-lg border-l-4 flex items-center justify-between {% if message.tags == 'success' %}border-l-green-500 bg-green-900/20{% elif message.tags == 'error' %}border-l-red-500 bg-red-900/20{% else %}border-l-blue-500 bg-blue-900/20{% endif %}">
                <span class="font-bold text-sm">{{ message }}</span>
                <button onclick="this.parentElement.remove()" class="text-xs opacity-50 hover:opacity-100">âœ•</button>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% block content %}
        {% endblock %}
    </main>

    <script>
        function checkNotifications() {
            fetch('{% url "check_notifications" %}')
                .then(r => r.json())
                .then(data => {
                    const badge = document.getElementById('notif-badge');
                    
                    // Update Ticker & Threat Level based on data
                    // Assuming API returns critical_count or similar, if not we infer from notifications
                    // For now, let's look at the notifications array to find criticals
                    
                    const notifs = data.notifications || [];
                    const criticals = notifs.filter(n => n.level === 'CRITICAL');
                    updateSecurityStatus(criticals);

                    if (data.status === 'alert' && data.count > 0) {
                        if (badge) {
                            badge.innerText = data.count;
                            badge.classList.remove('hidden');
                        }
                        
                        // Show Toast for the latest notification if it's new
                        const latest = notifs[0];
                        if (latest && !document.getElementById('toast-' + latest.id)) {
                             showToast(latest.id, latest.title, latest.message, latest.level, latest.report_id);
                        }
                    } else {
                        if (data.count === 0 && badge) badge.classList.add('hidden');
                    }
                })
                .catch(e => console.error("Polling error:", e));
        }

        function updateSecurityStatus(criticals) {
            const threatBar = document.getElementById('threat-level-bar');
            const threatText = document.getElementById('threat-text');
            const d1 = document.getElementById('defcon-1');
            const d2 = document.getElementById('defcon-2');
            const d3 = document.getElementById('defcon-3');

            if (criticals.length > 0) {
                // HIGH THREAT
                if (threatBar) threatBar.classList.remove('hidden');
                if (threatText) {
                    threatText.innerText = "CRITICAL";
                    threatText.className = "text-xs font-bold text-red-500 ml-2 animate-pulse";
                }
                if (d1) d1.className = "w-3 h-3 rounded-full bg-red-600 shadow-[0_0_10px_red]";
                if (d2) d2.className = "w-3 h-3 rounded-full bg-red-600 shadow-[0_0_10px_red]";
                if (d3) d3.className = "w-3 h-3 rounded-full bg-red-600 shadow-[0_0_10px_red]";
            } else {
                // NORMAL
                if (threatBar) threatBar.classList.remove('hidden');
                if (threatText) {
                    threatText.innerText = "NORMAL";
                    threatText.className = "text-xs font-bold text-emerald-500 ml-2";
                }
                if (d1) d1.className = "w-3 h-3 rounded-full bg-emerald-600";
                if (d2) d2.className = "w-3 h-3 rounded-full bg-slate-800";
                if (d3) d3.className = "w-3 h-3 rounded-full bg-slate-800";
            }
        }
    
        setInterval(checkNotifications, 10000); // Poll every 10s for demo
        checkNotifications(); // Initial check
        
        function showToast(id, title, msg, type, report_id) {
            // Modern "Sovereign Capsule" Design (Non-intrusive, High-Tech)
            const existing = document.getElementById('toast-' + id);
            if (existing) return;

            const toast = document.createElement('div');
            toast.id = 'toast-' + id;
            
            // Base Capsule Style
            // Top-centered, rounded-full, backdrop blur, glowing border
            toast.className = `fixed top-8 left-1/2 transform -translate-x-1/2 z-50 transition-all duration-500 ease-out translate-y-[-100px] opacity-0`;
            
            // Inner Content
            // We use a group to handle hover/expansion
            // Initial state: Compact Capsule
            const isCritical = type === 'CRITICAL';
            const borderColor = isCritical ? 'border-red-500/50' : 'border-blue-500/50';
            const glowColor = isCritical ? 'shadow-[0_0_20px_rgba(239,68,68,0.3)]' : 'shadow-[0_0_20px_rgba(59,130,246,0.3)]';
            const icon = isCritical ? 'ğŸš¨' : 'â„¹ï¸';
            
            toast.innerHTML = `
                <div class="relative group bg-[#0b1220]/90 backdrop-blur-xl border ${borderColor} ${glowColor} rounded-full px-5 py-2.5 flex items-center gap-4 hover:rounded-2xl hover:px-6 hover:py-4 transition-all duration-300 cursor-default min-w-[320px] max-w-[500px]">
                    
                    <!-- Icon Pulse -->
                    <div class="relative shrink-0">
                        <span class="text-xl">${icon}</span>
                        ${isCritical ? '<span class="absolute inset-0 rounded-full bg-red-500/20 animate-ping"></span>' : ''}
                    </div>

                    <!-- Content Container -->
                    <div class="flex-1 flex flex-col justify-center">
                        <!-- Compact View (Title Only) -->
                        <div class="flex justify-between items-center w-full">
                            <span class="font-bold text-sm text-white tracking-wide truncate max-w-[200px] group-hover:max-w-none transition-all">${title}</span>
                            <span class="text-[10px] opacity-50 ml-2 font-mono whitespace-nowrap">${new Date().toLocaleTimeString('ar-SA')}</span>
                        </div>
                        
                        <!-- Expanded View (Message + Actions) - Hidden by default, visible on hover -->
                        <div class="hidden group-hover:block mt-2 pt-2 border-t border-white/10 animate-fade-in">
                            <p class="text-xs text-slate-300 leading-relaxed mb-3">${msg}</p>
                            <div class="flex justify-end gap-2">
                                <button onclick="markRead(${id}, this)" class="px-3 py-1 text-[10px] rounded hover:bg-white/10 text-slate-400 transition">ØªØ¬Ø§Ù‡Ù„</button>
                                ${report_id ? `<a href="/intelligence/alerts/analysis/${report_id}/" class="px-3 py-1 text-[10px] rounded bg-red-600 hover:bg-red-500 text-white font-bold shadow-lg shadow-red-900/50 transition flex items-center gap-1">Ø¹Ø±Ø¶ Ø§Ù„ØªØ­Ù„ÙŠÙ„ <span class="text-[9px]">â†—</span></a>` : ''}
                            </div>
                        </div>
                    </div>

                    <!-- Close Button (Visible on hover) -->
                    <button onclick="markRead(${id}, this)" class="absolute -top-1 -left-1 bg-slate-800 rounded-full p-1 opacity-0 group-hover:opacity-100 transition shadow border border-white/10">
                        <svg class="w-3 h-3 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Animate In
            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-[-100px]', 'opacity-0');
            });
            
            // Auto-dismiss for non-critical after 5s
            if (!isCritical) {
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        markRead(id, null); // Just mark read or just remove? Better remove UI only.
                        // Actually, let's just fade it out without marking read via API if user didn't interact
                        toast.classList.add('translate-y-[-100px]', 'opacity-0');
                        setTimeout(() => toast.remove(), 500);
                    }
                }, 8000);
            }
        }

        function markRead(id, btn) {
            fetch(`/intelligence/api/notifications/${id}/read/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            }).then(() => {
                if(btn) {
                    const toast = btn.closest('div[id^="toast-"]');
                    if(toast) toast.remove();
                }
                checkNotifications(); // Update badge
            });
        }
    </script>

</body>
</html>
