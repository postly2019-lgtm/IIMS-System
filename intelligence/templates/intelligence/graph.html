{% extends 'intelligence/base.html' %}

{% block content %}
<div class="glass-panel p-6 mb-6">
    <h2 class="text-xl font-bold text-white">الخريطة الاستخباراتية</h2>
    <p class="text-slate-400 text-sm">عرض العلاقات بين التقارير والكيانات</p>
</div>

<div class="glass-panel p-4">
    <div id="network" class="w-full h-[600px] bg-slate-900 rounded border border-slate-700"></div>
</div>

<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<script>
    async function loadGraph() {
        const res = await fetch('{% url "graph_data" %}');
        const data = await res.json();

        const nodes = new vis.DataSet(data.nodes.map(n => ({
            id: n.id,
            label: n.label,
            group: n.group,
            value: n.value,
            color: n.group === 'report' ? '#1d4ed8' : '#10b981'
        })));

        const edges = new vis.DataSet(data.edges.map(e => ({
            from: e.from,
            to: e.to,
            arrows: e.arrows || undefined,
            color: e.color?.color || '#64748b',
            dashes: e.dashes || false
        })));

        const container = document.getElementById('network');
        const options = {
            layout: { improvedLayout: true },
            physics: {
                solver: 'barnesHut',
                stabilization: { iterations: 50 },
                maxVelocity: 30
            },
            interaction: { hover: true },
            edges: { smooth: true }
        };
        const network = new vis.Network(container, { nodes, edges }, options);
    }

    loadGraph();
</script>
{% endblock %}
