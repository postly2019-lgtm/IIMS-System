{% extends 'intelligence/base.html' %}
{% load static %}
{% load agent_filters %}

{% block title %}ØºØ±ÙØ© Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø°ÙƒÙŠ | Ù…Ù†ØµØ© Ø§Ù„Ø§Ø³ØªÙ‚ØµØ§Ø¡{% endblock %}

{% block content %}
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
    .font-cairo { font-family: 'Cairo', sans-serif; }
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    
    /* Custom Scrollbar for messages */
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: rgba(30, 41, 59, 0.5); }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(71, 85, 105, 0.8); border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(100, 116, 139, 1); }

    .glass-panel {
        background: rgba(15, 23, 42, 0.7);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(148, 163, 184, 0.1);
    }
</style>

<div class="flex h-[calc(100vh-6rem)] gap-6 font-cairo text-slate-200">
    <!-- Sidebar History -->
    <div class="w-72 glass-panel rounded-2xl flex flex-col overflow-hidden shadow-2xl transition-all duration-300">
        <div class="p-4 border-b border-slate-700/50">
            <a href="{% url 'agent_new_session' %}" class="group w-full bg-gradient-to-r from-cyan-700 to-blue-700 hover:from-cyan-600 hover:to-blue-600 text-white rounded-xl p-3.5 flex items-center justify-center gap-3 transition-all shadow-lg hover:shadow-cyan-900/20">
                <span class="text-lg font-bold">+</span> 
                <span class="font-semibold tracking-wide">Ø¬Ù„Ø³Ø© ØªØ­Ù„ÙŠÙ„ Ø¬Ø¯ÙŠØ¯Ø©</span>
            </a>
        </div>
        
        <div class="flex-1 overflow-y-auto custom-scrollbar p-3 space-y-2">
            <div class="text-xs font-bold text-slate-500 uppercase tracking-wider px-2 mb-2">Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¯ÙŠØ«</div>
            {% for session in sessions %}
            <a href="{% url 'agent_chat' session.id %}" 
               class="block p-3.5 rounded-xl border transition-all duration-200 group relative overflow-hidden
               {% if session.id == active_session.id %}
                   bg-slate-800/80 border-cyan-500/30 text-cyan-100 shadow-md
               {% else %}
                   bg-transparent border-transparent hover:bg-slate-800/50 text-slate-400 hover:text-slate-200
               {% endif %}">
                
                {% if session.id == active_session.id %}
                <div class="absolute left-0 top-0 bottom-0 w-1 bg-cyan-500"></div>
                {% endif %}
                
                <div class="flex items-center justify-between mb-1 group">
                    <span class="truncate font-medium text-sm w-full">{{ session.title|default:"Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©" }}</span>
                    <button onclick="deleteSession(event, {{ session.id }})" class="opacity-0 group-hover:opacity-100 p-1 hover:text-red-400 transition-all">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                    </button>
                </div>
                <div class="flex items-center gap-1 text-[10px] opacity-60">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    {{ session.last_interaction|date:"d/m H:i" }}
                </div>
            </a>
            {% endfor %}
        </div>

        <div class="p-4 border-t border-slate-700/50 bg-slate-900/30">
            <a href="{% url 'agent_settings' %}" class="flex items-center gap-3 text-slate-400 hover:text-cyan-400 transition-colors text-sm font-medium p-2 rounded-lg hover:bg-slate-800/50">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆÙƒÙŠÙ„ ÙˆØ§Ù„Ø°Ø§ÙƒØ±Ø©
            </a>
        </div>
    </div>

    <!-- Chat Area -->
    <div class="flex-1 glass-panel rounded-2xl flex flex-col relative overflow-hidden shadow-2xl">
        {% if not active_session %}
        <div class="flex-1 flex flex-col items-center justify-center text-slate-500 space-y-8">
            <div class="relative w-32 h-32">
                <div class="absolute inset-0 bg-cyan-500/10 rounded-full blur-xl animate-pulse"></div>
                <div class="relative w-full h-full rounded-full bg-slate-900/80 border border-slate-700/50 flex items-center justify-center shadow-2xl">
                    <img src="{% static 'images/logo.png' %}" alt="Logo" class="w-20 h-20 opacity-80 drop-shadow-[0_0_15px_rgba(6,182,212,0.3)]">
                </div>
            </div>
            
            <div class="text-center space-y-3">
                <h2 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-slate-100 to-slate-400">
                    Ù…Ù†ØµØ© Ø§Ù„Ø§Ø³ØªÙ‚ØµØ§Ø¡ Ø§Ù„Ø°ÙƒÙŠ
                </h2>
                <p class="text-slate-400 text-lg font-light tracking-wide border-t border-slate-800/50 pt-3 mt-2">
                    Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ù† Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…ÙØªÙˆØ­Ø©
                </p>
            </div>
            
            <a href="{% url 'agent_new_session' %}" class="group relative px-8 py-3 bg-cyan-950/30 overflow-hidden rounded-full transition-all hover:shadow-[0_0_20px_rgba(6,182,212,0.15)] border border-cyan-900/50 hover:border-cyan-500/50">
                <div class="absolute inset-0 w-0 bg-gradient-to-r from-cyan-900/20 to-transparent transition-all duration-[250ms] ease-out group-hover:w-full"></div>
                <span class="relative text-cyan-400 font-bold group-hover:text-cyan-300 flex items-center gap-2">
                    <span class="text-xl">+</span>
                    Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ø³ØªÙ‚ØµØ§Ø¡ Ø¬Ø¯ÙŠØ¯Ø©
                </span>
            </a>
        </div>
        {% else %}
        
        <!-- Header -->
        <div class="h-16 border-b border-slate-700/50 flex items-center justify-between px-6 bg-slate-900/30 backdrop-blur-sm z-10">
            <div class="flex items-center gap-3">
                <div class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.6)]"></div>
                <h3 class="font-bold text-lg text-slate-200 truncate max-w-md">{{ active_session.title }}</h3>
            </div>
            <div class="text-xs text-slate-500 font-mono">ID: {{ active_session.id }}</div>
        </div>

        <!-- Messages -->
        <div id="chat-messages" class="flex-1 overflow-y-auto custom-scrollbar p-6 space-y-8 scroll-smooth">
            {% for msg in messages %}
            <div class="flex gap-4 {% if msg.role == 'user' %}flex-row-reverse{% endif %} animate-fade-in group">
                <!-- Avatar -->
                <div class="w-10 h-10 rounded-full flex items-center justify-center shrink-0 shadow-lg border 
                    {% if msg.role == 'user' %}
                        bg-gradient-to-br from-cyan-600 to-blue-700 border-cyan-500/30
                    {% else %}
                        bg-gradient-to-br from-slate-700 to-slate-800 border-slate-600
                    {% endif %}">
                    {% if msg.role == 'user' %}
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                    {% else %}
                        <svg class="w-6 h-6 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                    {% endif %}
                </div>
                
                <!-- Bubble -->
                <div class="max-w-[85%] lg:max-w-[75%]">
                    <div class="p-5 rounded-2xl shadow-xl leading-relaxed text-sm md:text-base transition-all duration-200
                        {% if msg.role == 'user' %}
                            bg-cyan-900/20 border border-cyan-800/50 text-cyan-50 rounded-tr-sm
                        {% else %}
                            bg-slate-800/40 border border-slate-700/50 text-slate-200 rounded-tl-sm hover:border-slate-600
                        {% endif %}">
                        <div class="prose prose-invert prose-sm max-w-none prose-p:leading-relaxed prose-pre:bg-slate-900/50 prose-pre:border prose-pre:border-slate-700">
                            {{ msg.content|render_markdown }}
                        </div>
                    </div>
                    <div class="text-[10px] text-slate-600 mt-2 px-2 font-mono opacity-0 group-hover:opacity-100 transition-opacity {% if msg.role == 'user' %}text-left{% else %}text-right{% endif %}">
                        {{ msg.created_at|date:"H:i" }}
                    </div>
                </div>
            </div>
            {% endfor %}

            <!-- Typing Indicator -->
            <div id="typing-indicator" class="hidden flex gap-4 animate-fade-in">
                <div class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center shrink-0 border border-slate-700">
                    <svg class="w-5 h-5 text-cyan-400 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/></svg>
                </div>
                <div class="bg-slate-800/50 p-4 rounded-2xl rounded-tl-sm border border-slate-700 flex gap-1.5 items-center h-12 shadow-lg">
                    <span class="w-2 h-2 bg-cyan-500/50 rounded-full animate-bounce"></span>
                    <span class="w-2 h-2 bg-cyan-500/50 rounded-full animate-bounce delay-75"></span>
                    <span class="w-2 h-2 bg-cyan-500/50 rounded-full animate-bounce delay-150"></span>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="p-6 bg-slate-900/60 backdrop-blur-md border-t border-slate-700/50 relative z-20">
            <!-- File Indicator -->
            <div id="file-indicator" class="hidden absolute right-6 -top-12 bg-slate-800 text-xs px-4 py-2.5 rounded-lg text-cyan-400 border border-cyan-500/30 shadow-xl flex items-center gap-3 animate-slide-up">
                <span class="text-lg">ğŸ“</span>
                <span id="file-name" class="max-w-[200px] truncate font-mono"></span>
                <button type="button" onclick="clearFile()" class="text-slate-500 hover:text-red-400 transition ml-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>

            <form id="chat-form" class="relative group" enctype="multipart/form-data">
                {% csrf_token %}
                <textarea 
                    name="content" 
                    id="message-input"
                    rows="1"
                    class="w-full bg-slate-950/50 border border-slate-700 rounded-2xl pl-24 pr-6 py-4 text-slate-200 placeholder-slate-500 focus:border-cyan-500/50 focus:ring-1 focus:ring-cyan-500/50 focus:bg-slate-900 outline-none resize-none scrollbar-hide shadow-inner transition-all leading-relaxed"
                    placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ…Ø§ØªÙƒ Ù„Ù„ØªØ­Ù„ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø± Ù‡Ù†Ø§..."
                    onkeydown="if(event.keyCode == 13 && !event.shiftKey) { event.preventDefault(); this.form.requestSubmit(); }"></textarea>
                
                <!-- File Upload Button -->
                <label for="file-upload" class="absolute left-16 top-3 bottom-3 text-slate-400 hover:text-cyan-400 w-10 flex items-center justify-center cursor-pointer transition-colors border-r border-slate-700/50 pr-2" title="Ø¥Ø±ÙØ§Ù‚ Ù…Ù„Ù">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg>
                    <input id="file-upload" type="file" name="attachment" class="hidden" onchange="updateFileIndicator(this)">
                </label>

                <!-- Send Button -->
                <button type="submit" class="absolute left-3 top-3 bottom-3 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white w-10 rounded-xl flex items-center justify-center transition-all shadow-lg hover:shadow-cyan-500/20 disabled:opacity-50 disabled:cursor-not-allowed transform active:scale-95">
                    <svg class="w-5 h-5 rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/></svg>
                </button>
            </form>
        </div>
        {% endif %}
    </div>
</div>

<script>
    const chatMessages = document.getElementById('chat-messages');
    if (chatMessages) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function updateFileIndicator(input) {
        const indicator = document.getElementById('file-indicator');
        const fileNameSpan = document.getElementById('file-name');
        if (input.files && input.files[0]) {
            fileNameSpan.textContent = input.files[0].name;
            indicator.classList.remove('hidden');
        } else {
            indicator.classList.add('hidden');
        }
    }

    function clearFile() {
        const input = document.getElementById('file-upload');
        input.value = '';
        updateFileIndicator(input);
    }

    document.getElementById('chat-form')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const form = e.target;
        const input = document.getElementById('message-input');
        const fileInput = document.getElementById('file-upload');
        const content = input.value.trim();
        
        // Prevent empty submission
        if (!content && (!fileInput.files || fileInput.files.length === 0)) {
            return;
        }

        // Create FormData from the form element directly
        const formData = new FormData(form);
        
        // Append User Message Locally
        if (content) {
            appendMessage('user', content);
        }

        if (fileInput.files && fileInput.files.length > 0) {
            const messagesDiv = document.getElementById('chat-messages');
            const fileMsgHtml = `
            <div class="flex gap-4 flex-row-reverse animate-fade-in mb-6 group">
                <div class="w-10 h-10 rounded-full flex items-center justify-center shrink-0 bg-gradient-to-br from-cyan-600 to-blue-700 shadow-lg">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                </div>
                <div class="max-w-[80%]">
                    <div class="p-4 rounded-xl bg-cyan-900/20 border border-cyan-700/50 text-white shadow-lg leading-relaxed flex items-center gap-3">
                        <span class="text-xl">ğŸ“</span> 
                        <span class="font-mono text-sm opacity-90">Ù…Ø±ÙÙ‚: ${fileInput.files[0].name}</span>
                    </div>
                    <div class="text-[10px] text-slate-500 mt-2 px-2 text-left font-mono">Now</div>
                </div>
            </div>`;
            messagesDiv.insertAdjacentHTML('beforeend', fileMsgHtml);
        }

        // Clear inputs immediately
        input.value = '';
        
        // Show Typing
        const typingIndicator = document.getElementById('typing-indicator');
        typingIndicator.classList.remove('hidden');
        chatMessages.scrollTop = chatMessages.scrollHeight;

        try {
            // Ensure we have a valid session ID
            const sessionId = "{{ active_session.id|default:0 }}";
            
            const response = await fetch("{% url 'agent_send_message' active_session.id|default:0 %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            
            // Hide Typing
            typingIndicator.classList.add('hidden');
            
            if (data.status === 'success') {
                appendMessage('assistant', data.ai_message);
                clearFile(); // Clear file input after successful send
            } else {
                 console.error('Server returned error:', data);
            }
        } catch (error) {
            console.error('Error:', error);
            typingIndicator.classList.add('hidden');
            // Optionally show error to user
            appendMessage('assistant', '[Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…]: ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
        }
    });

    function appendMessage(role, content) {
        const div = document.createElement('div');
        div.className = `flex gap-4 ${role === 'user' ? 'flex-row-reverse' : ''} animate-fade-in mb-6 group`;
        
        // Avatar
        const avatarDiv = document.createElement('div');
        avatarDiv.className = `w-10 h-10 rounded-full flex items-center justify-center shrink-0 shadow-lg border ${role === 'user' ? 'bg-gradient-to-br from-cyan-600 to-blue-700 border-cyan-500/30' : 'bg-gradient-to-br from-slate-700 to-slate-800 border-slate-600'}`;
        avatarDiv.innerHTML = role === 'user' 
            ? '<svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>'
            : '<svg class="w-6 h-6 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>';
        
        // Message Body Container
        const msgContainer = document.createElement('div');
        msgContainer.className = 'max-w-[85%] lg:max-w-[75%]';
        
        // Bubble
        const bubble = document.createElement('div');
        bubble.className = `p-5 rounded-2xl shadow-xl leading-relaxed text-sm md:text-base transition-all duration-200 ${role === 'user' ? 'bg-cyan-900/20 border border-cyan-800/50 text-cyan-50 rounded-tr-sm' : 'bg-slate-800/40 border border-slate-700/50 text-slate-200 rounded-tl-sm hover:border-slate-600'}`;
        
        // Content with Markdown Rendering (Client-side simple approximation or just text)
        // Since we don't have client-side markdown lib loaded, we'll rely on textContent for safety, 
        // or innerHTML if we trust the source. The server returns raw text usually.
        // For consistency with server template, we should ideally parse markdown, but for now text is safe.
        // However, the previous code used textContent. Let's keep it safe.
        // Wait, the server returns markdown. We should try to preserve newlines at least.
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'prose prose-invert prose-sm max-w-none';
        contentDiv.style.whiteSpace = 'pre-wrap';
        contentDiv.textContent = content;
        
        bubble.appendChild(contentDiv);
        
        // Timestamp
        const timeDiv = document.createElement('div');
        timeDiv.className = `text-[10px] text-slate-600 mt-2 px-2 font-mono opacity-0 group-hover:opacity-100 transition-opacity ${role === 'user' ? 'text-left' : 'text-right'}`;
        timeDiv.textContent = 'Now';
        
        msgContainer.appendChild(bubble);
        msgContainer.appendChild(timeDiv);
        
        div.appendChild(avatarDiv);
        div.appendChild(msgContainer);
        
        const typingIndicator = document.getElementById('typing-indicator');
        typingIndicator.before(div);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    async function deleteSession(event, sessionId) {
        event.preventDefault(); // Prevent link navigation
        event.stopPropagation();
        
        if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©ØŸ')) return;

        try {
            const response = await fetch(`/agent/chat/${sessionId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });

            if (response.ok) {
                // If current session, redirect to new session
                if (window.location.href.includes(`/${sessionId}/`)) {
                    window.location.href = "{% url 'agent_new_session' %}";
                } else {
                    // Just reload to update list
                    window.location.reload();
                }
            } else {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù');
            }
        } catch (error) {
            console.error('Error deleting session:', error);
            alert('ØªØ¹Ø°Ø± Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©');
        }
    }
</script>
{% endblock %}
